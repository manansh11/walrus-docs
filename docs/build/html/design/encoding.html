<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encoding - Walrus</title>


        <!-- Custom HTML head -->
        <script type="text/javascript">
          // Hacky check to only load Amplitude in production since we don't have environments:
          const localAddresses = ['localhost', '127.0.0.1', '[::1]'];
          if (localAddresses.indexOf(document.location.hostname) === -1) {
            !function(){"use strict";!function(e,t){var r=e.amplitude||{_q:[],_iq:{}};if(r.invoked)e.console&&console.error&&console.error("Amplitude snippet has been loaded.");else{var n=function(e,t){e.prototype[t]=function(){return this._q.push({name:t,args:Array.prototype.slice.call(arguments,0)}),this}},s=function(e,t,r){return function(n){e._q.push({name:t,args:Array.prototype.slice.call(r,0),resolve:n})}},o=function(e,t,r){e._q.push({name:t,args:Array.prototype.slice.call(r,0)})},i=function(e,t,r){e[t]=function(){if(r)return{promise:new Promise(s(e,t,Array.prototype.slice.call(arguments)))};o(e,t,Array.prototype.slice.call(arguments))}},a=function(e){for(var t=0;t<g.length;t++)i(e,g[t],!1);for(var r=0;r<m.length;r++)i(e,m[r],!0)};r.invoked=!0;var c=t.createElement("script");c.type="text/javascript",c.integrity="sha384-pY2pkwHaLM/6UIseFHVU3hOKr6oAvhLcdYkoRZyaMDWLjpM6B7nTxtOdE823WAOQ",c.crossOrigin="anonymous",c.async=!0,c.src="https://cdn.amplitude.com/libs/analytics-browser-2.11.0-min.js.gz",c.onload=function(){e.amplitude.runQueuedFunctions||console.log("[Amplitude] Error: could not load SDK")};var u=t.getElementsByTagName("script")[0];u.parentNode.insertBefore(c,u);for(var p=function(){return this._q=[],this},l=["add","append","clearAll","prepend","set","setOnce","unset","preInsert","postInsert","remove","getUserProperties"],d=0;d<l.length;d++)n(p,l[d]);r.Identify=p;for(var f=function(){return this._q=[],this},v=["getEventProperties","setProductId","setQuantity","setPrice","setRevenue","setRevenueType","setEventProperties"],y=0;y<v.length;y++)n(f,v[y]);r.Revenue=f;var g=["getDeviceId","setDeviceId","getSessionId","setSessionId","getUserId","setUserId","setOptOut","setTransport","reset","extendSession"],m=["init","add","remove","track","logEvent","identify","groupIdentify","setGroup","revenue","flush"];a(r),r.createInstance=function(e){return r._iq[e]={_q:[]},a(r._iq[e]),r._iq[e]},e.amplitude=r}}(window,document)}();
            amplitude.init('f60df2d0d709d50faa2ffda153a84bc0', { identityStorage:'none', defaultTracking: true });
          }
        </script>
        
        <script>
            function initAskCookbook() {
              // It's a public API key, so it's safe to expose it here
              const PUBLIC_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2NzU4Y2YyODM4NTcxODU5MjU0MGIyMDciLCJpYXQiOjE3MzM4NzM0NDgsImV4cCI6MjA0OTQ0OTQ0OH0.Z3cv3HuMkYq3aYZYzCKkkYuM5LI3KG-kuA0R-GaSMV4";
        
              let cookbookContainer = document.getElementById("__cookbook");
              if (!cookbookContainer) {
                cookbookContainer = document.createElement("div");
                cookbookContainer.id = "__cookbook";
                cookbookContainer.dataset.apiKey = PUBLIC_API_KEY;
                document.body.appendChild(cookbookContainer);
              }
        
              let cookbookScript = document.getElementById("__cookbook-script");
              if (!cookbookScript) {
                cookbookScript = document.createElement("script");
                cookbookScript.id = "__cookbook-script";
                cookbookScript.src = "https://cdn.jsdelivr.net/npm/@cookbookdev/docsbot/dist/standalone/index.cjs.js";
                cookbookScript.async = true;
                document.head.appendChild(cookbookScript);
              }
        
        
              const keyPressPropagationBlocker = function (e) {
                e.stopPropagation();
              };
              document.addEventListener("cookbook:modal:state:change", function (e) {
                const isOpen = e.detail.isOpen;
                if (isOpen) {
                  document.body.addEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                } else {
                  document.body.removeEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                }
              });
            }
        
            // Check if the document is already loaded and if so, initialize the script, otherwise wait for the load event
            if (document.readyState === "complete") {
              initAskCookbook();
            } else {
              window.addEventListener("load", initAskCookbook);
            }
          </script>
        
          <meta name="algolia-site-verification" content="BCA21DA2879818D2">

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../docs/mdbook-admonish.css">
        <link rel="stylesheet" href="../docs/theme/tabs.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Walrus</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="encoding-overheads-and-verification"><a class="header" href="#encoding-overheads-and-verification">Encoding, overheads, and verification</a></h1>
<p>Walrus uses a bespoke erasure-code construction (RedStuff) based on efficiently computable
Reed-Solomon codes. The full details of the encoding are described in the
<a href="../walrus.pdf">whitepaper</a>. This page summarizes some of the basic techniques and terminology used
by Walrus. See also the <a href="../glossary.html">glossary</a>.</p>
<h2 id="basics"><a class="header" href="#basics">Basics</a></h2>
<p>The following list summarizes the basic encoding and cryptographic techniques used in Walrus:</p>
<ul>
<li>
<p>An <a href="https://en.wikipedia.org/wiki/Erasure_code">erasure code</a> encode algorithm takes a blob,
splits it into a number <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> of symbols, and encodes it into <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> symbols in such a way that a
subset of these <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> symbols can be used to reconstruct the blob.</p>
</li>
<li>
<p>Walrus uses a highly efficient erasure code and selects <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> such that a third of symbols can be
used to reconstruct the blob by the decode algorithm.</p>
</li>
<li>
<p>The encoding is <em>systematic</em>, meaning that some storage nodes hold part of the original blob,
allowing for fast random-access reads.</p>
</li>
<li>
<p>All encoding and decoding operations are deterministic, and encoders have no discretion about it.</p>
</li>
<li>
<p>For each blob, multiple symbols are combined into a <strong>sliver</strong>, which is then assigned to a shard.</p>
</li>
<li>
<p>Storage nodes manage one or more shards, and corresponding slivers of each blob are distributed
to all the storage shards.</p>
</li>
</ul>
<p>The detailed encoding setup results in an expansion of the blob size by a factor of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4.5</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span>.
This is independent of the number of shards and the number of storage nodes.</p>
<h2 id="metadata-and-data-authentication"><a class="header" href="#metadata-and-data-authentication">Metadata and data authentication</a></h2>
<p>Each blob is also associated with some metadata including a <strong>blob ID</strong> to allow data authenticity
verification:</p>
<ul>
<li>
<p>The blob ID is computed as an authenticator of the set of all shard data and metadata (byte size,
encoding, blob hash).</p>
<p>Walrus hashes a sliver representation in each of the shards and adds the resulting hashes into a
Merkle tree. Then the root of the Merkle tree is the blob hash used to derive the blob ID that
identifies the blob in the system.</p>
</li>
<li>
<p>Each storage node can use the blob ID to check if some shard data belongs to a blob using the
authenticated structure corresponding to the blob hash (Merkle tree). A successful check means
that the data is indeed as intended by the writer of the blob.</p>
</li>
</ul>
<h2 id="data-integrity-and-consistency"><a class="header" href="#data-integrity-and-consistency">Data integrity and consistency</a></h2>
<p>Slivers, metadata, and the blob ID are computed by the client when writing a blob. As clients are
generally untrusted, any step in this computation can be incorrect, either through a bug or on
purpose. Concretely, the client can make one or more of the following mistakes:</p>
<ol>
<li>Incorrectly compute slivers.</li>
<li>Incorrectly compute the sliver hashes based on the slivers.</li>
<li>Incorrectly compute the blob ID based on the sliver hashes and other metadata.</li>
</ol>
<p>Walrus has several mechanisms to detect each of these:</p>
<ul>
<li>
<p>Inconsistencies of the last type (incorrect blob-ID computation) are detected immediately by
storage nodes when the client attempts to upload metadata. Storage nodes will never issue storage
certificates for such blobs, and they are therefore never even certified.</p>
</li>
<li>
<p>Inconsistencies of the second type (incorrect sliver-hash computation) are generally detected
either before or shortly after certification, unless the slivers with incorrect hashes are handled
by malicious storage nodes.</p>
<p>Honest storage nodes that are assigned a sliver with an incorrect hash attempt to recover it from
other storage nodes and then notice the inconsistency. They can then extract one symbol per sliver
to form an <em>inconsistency proof</em>, which is then used to mark the blob as <em>invalid</em>. After this,
storage nodes can delete slivers belonging to inconsistently encoded blobs, and upon request
return either the inconsistency proof or an inconsistency certificate posted on chain.</p>
</li>
<li>
<p>Inconsistencies of the first type can also be detected by storage nodes. The process is the same
as in the case above, but it is not guaranteed to be triggered immediately after certification.</p>
<p>As a result, such inconsistencies may persist within the network for longer periods of time,
requiring additional client-side checks.</p>
</li>
</ul>
<p>The following sections describe the different types of consistency checks performed by clients.</p>
<div id="admonition-select-the-appropriate-consistency-check" class="admonition admonish-info" role="note" aria-labelledby="admonition-select-the-appropriate-consistency-check-title">
<div class="admonition-title">
<div id="admonition-select-the-appropriate-consistency-check-title">
<p>Select the appropriate consistency check</p>
</div>
<a class="admonition-anchor-link" href="#admonition-select-the-appropriate-consistency-check"></a>
</div>
<div>
<p>In the majority of cases, the default consistency check is sufficient, in particular if the writer
of the blob is trusted. The strict consistency check is only needed if specific availability
guarantees are required.</p>
</div>
</div>
<h3 id="default-consistency-check"><a class="header" href="#default-consistency-check">Default consistency check</a></h3>
<p>When reading a blob from Walrus, a client first checks the authenticity of the metadata and then
requests a subset of primary slivers checking their authenticity using the metadata. Using 334
authentic primary slivers, the original blob data can be decoded.</p>
<p>The encoding used by Walrus has the property that <em>the first 334 primary slivers contain the
(potentially padded) unencoded data</em>. This means that the (cryptographic) hashes of these slivers
together with the blob length uniquely determine the content of the blob. Therefore, by recomputing
the sliver hashes of the first 334 slivers and checking them against the metadata, the client can
verify that the decoded data is correct. If this check succeeds, the data is provided to the user,
otherwise an error is returned. This check provides the following guarantee:</p>
<div id="admonition-data-consistency-property" class="admonition admonish-tip" role="note" aria-labelledby="admonition-data-consistency-property-title">
<div class="admonition-title">
<div id="admonition-data-consistency-property-title">
<p>Data consistency property</p>
</div>
<a class="admonition-anchor-link" href="#admonition-data-consistency-property"></a>
</div>
<div>
<p>Any correct client attempting to read a blob will either read the specific value authenticated by
the writer or return an error.</p>
</div>
</div>
<h3 id="strict-consistency-check"><a class="header" href="#strict-consistency-check">Strict consistency check</a></h3>
<p>If the blob was encoded correctly, any set of 334 primary slivers decode to the same data. However,
if the writer of a blob encoded the data incorrectly, different sets of slivers may decode to
different data. Even in that case, there is only one correct value that can be read by an honest
client (guarantee stated above), but some read attempts may result in a failure while others
succeed. Furthermore, the blob may be detected as inconsistent by storage nodes at a later point,
after which all read attempts would fail.</p>
<p>For this reason, Walrus optionally offers a <em>strict consistency check</em>: After decoding the blob, the
client fully <em>re-encodes</em> it and recomputes all hashes and the blob ID. Only if that computation
results in the blob ID they are trying to read is the read considered successful.</p>
<p>This process <em>ensures that the original writer encoded the blob correctly</em>. Therefore, after a blob
was read successfully with the strict consistency check enabled, the following property holds:</p>
<div id="admonition-guarantee-after-strict-consistency-check-succeeded" class="admonition admonish-tip" role="note" aria-labelledby="admonition-guarantee-after-strict-consistency-check-succeeded-title">
<div class="admonition-title">
<div id="admonition-guarantee-after-strict-consistency-check-succeeded-title">
<p>Guarantee after strict consistency check succeeded</p>
</div>
<a class="admonition-anchor-link" href="#admonition-guarantee-after-strict-consistency-check-succeeded"></a>
</div>
<div>
<p>Any correct client attempting to read a blob during its lifetime will always succeed and read the
same data intended by the writer.</p>
</div>
</div>
<p>Note that for quilt patches, only a variant of the default consistency check is available, as only
part of the quilt is read.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../design/operations.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../design/operations.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../docs/theme/tabs.js"></script>



    </div>
    </body>
</html>
