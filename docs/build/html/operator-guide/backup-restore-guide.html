<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Backup and restore - Walrus</title>


        <!-- Custom HTML head -->
        <script type="text/javascript">
          // Hacky check to only load Amplitude in production since we don't have environments:
          const localAddresses = ['localhost', '127.0.0.1', '[::1]'];
          if (localAddresses.indexOf(document.location.hostname) === -1) {
            !function(){"use strict";!function(e,t){var r=e.amplitude||{_q:[],_iq:{}};if(r.invoked)e.console&&console.error&&console.error("Amplitude snippet has been loaded.");else{var n=function(e,t){e.prototype[t]=function(){return this._q.push({name:t,args:Array.prototype.slice.call(arguments,0)}),this}},s=function(e,t,r){return function(n){e._q.push({name:t,args:Array.prototype.slice.call(r,0),resolve:n})}},o=function(e,t,r){e._q.push({name:t,args:Array.prototype.slice.call(r,0)})},i=function(e,t,r){e[t]=function(){if(r)return{promise:new Promise(s(e,t,Array.prototype.slice.call(arguments)))};o(e,t,Array.prototype.slice.call(arguments))}},a=function(e){for(var t=0;t<g.length;t++)i(e,g[t],!1);for(var r=0;r<m.length;r++)i(e,m[r],!0)};r.invoked=!0;var c=t.createElement("script");c.type="text/javascript",c.integrity="sha384-pY2pkwHaLM/6UIseFHVU3hOKr6oAvhLcdYkoRZyaMDWLjpM6B7nTxtOdE823WAOQ",c.crossOrigin="anonymous",c.async=!0,c.src="https://cdn.amplitude.com/libs/analytics-browser-2.11.0-min.js.gz",c.onload=function(){e.amplitude.runQueuedFunctions||console.log("[Amplitude] Error: could not load SDK")};var u=t.getElementsByTagName("script")[0];u.parentNode.insertBefore(c,u);for(var p=function(){return this._q=[],this},l=["add","append","clearAll","prepend","set","setOnce","unset","preInsert","postInsert","remove","getUserProperties"],d=0;d<l.length;d++)n(p,l[d]);r.Identify=p;for(var f=function(){return this._q=[],this},v=["getEventProperties","setProductId","setQuantity","setPrice","setRevenue","setRevenueType","setEventProperties"],y=0;y<v.length;y++)n(f,v[y]);r.Revenue=f;var g=["getDeviceId","setDeviceId","getSessionId","setSessionId","getUserId","setUserId","setOptOut","setTransport","reset","extendSession"],m=["init","add","remove","track","logEvent","identify","groupIdentify","setGroup","revenue","flush"];a(r),r.createInstance=function(e){return r._iq[e]={_q:[]},a(r._iq[e]),r._iq[e]},e.amplitude=r}}(window,document)}();
            amplitude.init('f60df2d0d709d50faa2ffda153a84bc0', { identityStorage:'none', defaultTracking: true });
          }
        </script>
        
        <script>
            function initAskCookbook() {
              // It's a public API key, so it's safe to expose it here
              const PUBLIC_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2NzU4Y2YyODM4NTcxODU5MjU0MGIyMDciLCJpYXQiOjE3MzM4NzM0NDgsImV4cCI6MjA0OTQ0OTQ0OH0.Z3cv3HuMkYq3aYZYzCKkkYuM5LI3KG-kuA0R-GaSMV4";
        
              let cookbookContainer = document.getElementById("__cookbook");
              if (!cookbookContainer) {
                cookbookContainer = document.createElement("div");
                cookbookContainer.id = "__cookbook";
                cookbookContainer.dataset.apiKey = PUBLIC_API_KEY;
                document.body.appendChild(cookbookContainer);
              }
        
              let cookbookScript = document.getElementById("__cookbook-script");
              if (!cookbookScript) {
                cookbookScript = document.createElement("script");
                cookbookScript.id = "__cookbook-script";
                cookbookScript.src = "https://cdn.jsdelivr.net/npm/@cookbookdev/docsbot/dist/standalone/index.cjs.js";
                cookbookScript.async = true;
                document.head.appendChild(cookbookScript);
              }
        
        
              const keyPressPropagationBlocker = function (e) {
                e.stopPropagation();
              };
              document.addEventListener("cookbook:modal:state:change", function (e) {
                const isOpen = e.detail.isOpen;
                if (isOpen) {
                  document.body.addEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                } else {
                  document.body.removeEventListener("keydown", keyPressPropagationBlocker, { capture: true });
                }
              });
            }
        
            // Check if the document is already loaded and if so, initialize the script, otherwise wait for the load event
            if (document.readyState === "complete") {
              initAskCookbook();
            } else {
              window.addEventListener("load", initAskCookbook);
            }
          </script>
        
          <meta name="algolia-site-verification" content="BCA21DA2879818D2">

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../docs/mdbook-admonish.css">
        <link rel="stylesheet" href="../docs/theme/tabs.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Walrus</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="backup-and-restore-guide"><a class="header" href="#backup-and-restore-guide">Backup and restore guide</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Walrus storage nodes provide backup and restore functionality for the primary database containing
blob data. This guide covers configuration requirements, operational procedures, and best practices
for both automated and manual backup processes, as well as restore operations.</p>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info"></a>
</div>
<div>
<p>The current backup implementation creates full copies of the database files. This means backups
require substantial disk space (approximately the same size as your active database). A
checkpoint-based solution is planned for a future release.</p>
</div>
</div>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li>Storage node must be running with appropriate permissions to create backups</li>
<li>Sufficient disk space for backup storage (recommended: separate physical volume)</li>
<li>Unix/Linux operating system with support for Unix domain sockets</li>
<li><code>walrus</code> user account with appropriate permissions</li>
</ul>
<h3 id="local-administration-socket-configuration"><a class="header" href="#local-administration-socket-configuration">Local administration socket configuration</a></h3>
<p>The backup system communicates with running storage nodes through a Unix domain socket. To enable
this functionality:</p>
<ol>
<li>
<p><strong>Configure the administration socket path</strong> in your node configuration file:</p>
<pre><code class="language-yaml">admin_socket_path: /opt/walrus/admin.socket
</code></pre>
</li>
<li>
<p><strong>Restart the storage node</strong> to initialize the socket:</p>
<pre><code class="language-bash">sudo systemctl restart walrus-node.service
</code></pre>
</li>
<li>
<p><strong>Verify socket creation</strong>:</p>
<pre><code class="language-bash">ls -la /opt/walrus/admin.socket
</code></pre>
</li>
</ol>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning"></a>
</div>
<div>
<p>The storage node creates the socket with permissions <code>srw------- 1 walrus walrus</code>, ensuring
that only the <code>walrus</code> user can send operations to it. This is critical for security, as
operations sent to this socket are executed directly on the running storage node.</p>
<p>Currently supported operations include:</p>
<ul>
<li><strong>local-admin checkpoint</strong></li>
<li><strong>local-admin log-level</strong></li>
</ul>
</div>
</div>
<h2 id="automated-periodic-backups"><a class="header" href="#automated-periodic-backups">Automated periodic backups</a></h2>
<p>Storage nodes support scheduled automatic backups through checkpoint configuration. Add the
following configs to your node configuration:</p>
<pre><code class="language-yaml">checkpoint_config:
  # Directory where backups will be stored
  db_checkpoint_dir: /opt/walrus/checkpoints

  # Number of backups to retain (oldest will be deleted)
  max_db_checkpoints: 2

  # Backup frequency (example: 4-hour interval)
  db_checkpoint_interval:
    secs: 14400  # 4 hours in seconds
    nanos: 0

  # Sync in-memory data to disk before creating a bakcup
  sync: true

  # Maximum concurrent backup operations
  max_background_operations: 1

  # Enable/disable automated backups
  periodic_db_checkpoints: true
</code></pre>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip"></a>
</div>
<div>
<p>To disable automated backups, set <code>periodic_db_checkpoints: false</code> in your configuration.</p>
</div>
</div>
<h2 id="manual-backup-creation"><a class="header" href="#manual-backup-creation">Manual backup creation</a></h2>
<p>Create on-demand backups using the <code>local-admin</code> command:</p>
<div id="admonition-info-1" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-1-title">
<div class="admonition-title">
<div id="admonition-info-1-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info-1"></a>
</div>
<div>
<p>The following commands assume <code>walrus-node</code> is in your system's PATH. If it's not, replace
<code>walrus-node</code> with the full path to the binary, for example:</p>
<ul>
<li><code>/opt/walrus/bin/walrus-node</code></li>
</ul>
</div>
</div>
<pre><code class="language-bash"># Basic backup command
sudo -u walrus walrus-node local-admin \
  --socket-path /opt/walrus/admin.socket \
  checkpoint create \
  --path /opt/walrus/backups/manual-backup-name
</code></pre>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip-1"></a>
</div>
<div>
<p>The backup operation runs in the background within the storage node. Once the backup creation is
initialized, the process continues independently even if the command-line interface is terminated.</p>
</div>
</div>
<h2 id="list-available-backups"><a class="header" href="#list-available-backups">List Available Backups</a></h2>
<pre><code class="language-bash">sudo -u walrus walrus-node local-admin \
  --socket-path /opt/walrus/admin.socket \
  checkpoint list \
  --path /opt/walrus/checkpoints
</code></pre>
<p><strong>Sample output:</strong></p>
<pre><code class="language-console">Backups:
Backup ID: 1, Size: 85.9 GB, Files: 1055, Created: 2025-07-02T00:25:48Z
Backup ID: 2, Size: 86.2 GB, Files: 1058, Created: 2025-07-02T04:25:52Z
</code></pre>
<h2 id="restore-from-a-backup"><a class="header" href="#restore-from-a-backup">Restore from a backup</a></h2>
<div id="admonition-warning-1" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-1-title">
<div class="admonition-title">
<div id="admonition-warning-1-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning-1"></a>
</div>
<div>
<p>Do not copy backup directories directly to the storage node's data path. The restore tool must be
used to properly reconstruct the database from checkpoint files. Directly copied content cannot be
recognized by the storage engine.</p>
</div>
</div>
<p>Follow these steps to restore from a backup:</p>
<ol>
<li>
<p><strong>Stop the storage node service</strong>:</p>
<pre><code class="language-bash">sudo systemctl stop walrus-node.service

# Verify the service is stopped
sudo systemctl status walrus-node.service
</code></pre>
</li>
<li>
<p><strong>Optional: Backup current database</strong></p>
<pre><code class="language-bash"># Assuming the Walrus storage path is: `storage_path: /opt/walrus/db`
sudo -u walrus cp -r /opt/walrus/db /opt/walrus/db.backup.$(date +%Y%m%d-%H%M%S)
</code></pre>
<p>This command saves:</p>
<ul>
<li>Main database files</li>
<li>Events database (<code>/opt/walrus/db/events/</code>)</li>
<li>Event blob data (<code>/opt/walrus/db/event_blob_writer/</code>)</li>
</ul>
</li>
<li>
<p><strong>Clear existing data</strong> (if performing a clean restore):</p>
<p>Remove all existing database files to ensure a clean restore,</p>
<pre><code class="language-bash"># Assuming the Walrus storage path is: `storage_path: /opt/walrus/db`
sudo -u walrus rm -rf /opt/walrus/db/*
</code></pre>
<p>This command removes:</p>
<ul>
<li>Main database files</li>
<li>Events database (<code>/opt/walrus/db/events/</code>)</li>
<li>Event blob data (<code>/opt/walrus/db/event_blob_writer/</code>)</li>
</ul>
</li>
<li>
<p><strong>Restore main database</strong>:</p>
<div id="admonition-warning-2" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-2-title">
<div class="admonition-title">
<div id="admonition-warning-2-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning-2"></a>
</div>
<div>
<p>The restore process can take significant time depending on database size. Run the restore command
in a persistent session using <code>tmux</code> or <code>screen</code> to prevent interruption if your connection drops.</p>
</div>
</div>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p>As mentioned earlier, if <code>walrus-node</code> is not in your PATH, use the full path to the binary.</p>
</div>
</div>
<pre><code class="language-bash"># Restore from specific checkpoint
sudo -u walrus walrus-node \
  restore \
  --db-checkpoint-path /opt/walrus/checkpoints \
  --db-path /opt/walrus/db \
  --checkpoint-id 2

# Or restore from latest checkpoint (omit --checkpoint-id)
sudo -u walrus walrus-node \
  restore \
  --db-checkpoint-path /opt/walrus/checkpoints \
  --db-path /opt/walrus/db
</code></pre>
</li>
<li>
<p><strong>Start the storage node</strong>:</p>
<pre><code class="language-bash">sudo systemctl start walrus-node.service

# Monitor startup logs
sudo journalctl -u walrus-node.service -f
</code></pre>
</li>
</ol>
<p>The storage node will begin downloading and replaying events. This process may take some time before
the node transitions to <code>Active</code> state.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../operator-guide/commission-governance.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../operator-guide/upload-relay.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../operator-guide/commission-governance.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../operator-guide/upload-relay.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../docs/theme/tabs.js"></script>



    </div>
    </body>
</html>
